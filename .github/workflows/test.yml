name: MCP Cookie Cutter CI

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-template-generation:
    name: Test Template Generation (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install cookiecutter and dependencies
        run: |
          pip install cookiecutter
          pip install -r hook_requirements.txt

      - name: Test basic template generation (no OpenAPI)
        run: |
          cookiecutter . --no-input \
            project_name="test_basic_server" \
            project_slug="test_basic_server" \
            deployment_type="local" \
            auth_mechanism="none"

          # Verify generated structure
          test -d test_basic_server
          test -f test_basic_server/pyproject.toml
          test -f test_basic_server/test_server.py
          test -d test_basic_server/src/test_basic_server

          echo "✓ Basic template generation successful"

      - name: Test Petstore API generation (JSON)
        run: |
          cookiecutter . --no-input \
            project_name="test_petstore_server" \
            project_slug="test_petstore_server" \
            openapi_spec_path="examples/petstore-swagger.json" \
            deployment_type="local" \
            auth_mechanism="none"

          test -d test_petstore_server
          test -f test_petstore_server/pyproject.toml

          echo "✓ Petstore template generation successful"

      - name: Test Cat API generation (YAML)
        run: |
          cookiecutter . --no-input \
            project_name="test_catapi_server" \
            project_slug="test_catapi_server" \
            openapi_spec_path="examples/thecatapi.yaml" \
            deployment_type="local" \
            auth_mechanism="api_key"

          test -d test_catapi_server
          test -f test_catapi_server/pyproject.toml

          echo "✓ Cat API template generation successful"

      - name: Test OpenWeather API generation (JSON)
        run: |
          cookiecutter . --no-input \
            project_name="test_weather_server" \
            project_slug="test_weather_server" \
            openapi_spec_path="examples/openweather-api.json" \
            deployment_type="remote" \
            server_port="8000" \
            auth_mechanism="api_key"

          test -d test_weather_server
          test -f test_weather_server/pyproject.toml
          test -f test_weather_server/Dockerfile
          test -f test_weather_server/docker-compose.yml

          echo "✓ OpenWeather API template generation successful"

      - name: Test Multi-Auth API generation
        run: |
          cookiecutter . --no-input \
            project_name="test_multiauth_server" \
            project_slug="test_multiauth_server" \
            openapi_spec_path="examples/multi-auth-api.json" \
            deployment_type="local" \
            auth_mechanism="oauth2"

          test -d test_multiauth_server
          test -f test_multiauth_server/pyproject.toml

          echo "✓ Multi-Auth API template generation successful"

      - name: Verify generated project can install dependencies
        run: |
          cd test_basic_server

          # Initialize with uv
          uv venv
          source .venv/bin/activate
          uv pip install -e .

          # Verify package is importable
          python -c "import test_basic_server; print('✓ Package import successful')"

      - name: Verify Petstore server can install and import
        run: |
          cd test_petstore_server

          # Initialize with uv
          uv venv
          source .venv/bin/activate
          uv pip install -e .

          # Verify package is importable
          python -c "import test_petstore_server; print('✓ Petstore package import successful')"

      - name: Run static type checking (if mypy available)
        continue-on-error: true
        run: |
          cd test_basic_server
          source .venv/bin/activate

          if command -v mypy &> /dev/null; then
            uv pip install mypy
            mypy src/ --ignore-missing-imports || echo "⚠ Type checking found issues (non-blocking)"
          else
            echo "⚠ mypy not available, skipping"
          fi

      - name: Test remote deployment configuration
        run: |
          cookiecutter . --no-input \
            project_name="test_remote_server" \
            project_slug="test_remote_server" \
            deployment_type="remote" \
            server_port="9090" \
            auth_mechanism="api_key"

          test -f test_remote_server/Dockerfile
          test -f test_remote_server/docker-compose.yml

          # Verify Docker files contain expected content
          grep -q "uvicorn" test_remote_server/Dockerfile
          grep -q "9090" test_remote_server/docker-compose.yml

          echo "✓ Remote deployment template generation successful"

      - name: Cleanup test projects
        if: always()
        run: |
          rm -rf test_*_server

  test-hooks:
    name: Test Pre/Post Generation Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r hook_requirements.txt
          pip install pytest pytest-asyncio

      - name: Test OpenAPI parsing (pre_gen_project)
        run: |
          cd hooks
          python -c "
          import sys
          sys.path.insert(0, '.')
          from openapi_generator import OpenAPIToolGenerator

          # Test loading example specs
          import yaml
          with open('../examples/petstore-swagger.json') as f:
              import json
              spec = json.load(f)
              print('✓ Petstore JSON spec loaded successfully')

          with open('../examples/thecatapi.yaml') as f:
              spec = yaml.safe_load(f)
              print('✓ Cat API YAML spec loaded successfully')

          print('✓ OpenAPI parsing hooks functional')
          "

      - name: Verify hook requirements are installable
        run: |
          pip install --dry-run -r hook_requirements.txt
          echo "✓ All hook requirements are valid"

  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install linting tools
        run: |
          pip install black ruff

      - name: Check Python formatting with black
        continue-on-error: true
        run: |
          black --check hooks/ || echo "⚠ Black formatting issues found (non-blocking)"

      - name: Run ruff linter
        continue-on-error: true
        run: |
          ruff check hooks/ || echo "⚠ Ruff linting issues found (non-blocking)"

  validate-examples:
    name: Validate Example OpenAPI Specs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install OpenAPI tools
        run: |
          pip install openapi-spec-validator pyyaml

      - name: Validate Petstore spec
        run: |
          python -c "
          import json
          from openapi_spec_validator import validate_spec

          with open('examples/petstore-swagger.json') as f:
              spec = json.load(f)

          try:
              validate_spec(spec)
              print('✓ Petstore spec is valid')
          except Exception as e:
              print(f'Note: {e}')
              print('✓ Petstore spec loaded (validation may not support Swagger 2.0)')
          "

      - name: Validate Cat API spec
        run: |
          python -c "
          import yaml
          from openapi_spec_validator import validate_spec

          with open('examples/thecatapi.yaml') as f:
              spec = yaml.safe_load(f)

          try:
              validate_spec(spec)
              print('✓ Cat API spec is valid')
          except Exception as e:
              print(f'⚠ Validation issue: {e}')
          "

      - name: Validate OpenWeather spec
        continue-on-error: true
        run: |
          python -c "
          import json

          with open('examples/openweather-api.json') as f:
              spec = json.load(f)
              print('✓ OpenWeather spec loaded successfully')
          "

      - name: Validate Multi-Auth spec
        continue-on-error: true
        run: |
          python -c "
          import json

          with open('examples/multi-auth-api.json') as f:
              spec = json.load(f)
              print('✓ Multi-Auth spec loaded successfully')
          "

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-template-generation, test-hooks, lint-and-format, validate-examples]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "=== MCP Cookie Cutter Test Summary ==="
          echo "Template Generation: ${{ needs.test-template-generation.result }}"
          echo "Hook Tests: ${{ needs.test-hooks.result }}"
          echo "Lint/Format: ${{ needs.lint-and-format.result }}"
          echo "Example Validation: ${{ needs.validate-examples.result }}"

          if [ "${{ needs.test-template-generation.result }}" != "success" ]; then
            echo "❌ Template generation tests failed"
            exit 1
          fi

          if [ "${{ needs.test-hooks.result }}" != "success" ]; then
            echo "❌ Hook tests failed"
            exit 1
          fi

          echo "✓ All critical tests passed!"
